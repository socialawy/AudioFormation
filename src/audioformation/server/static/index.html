
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioFormation Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè≠</text></svg>">
    <!-- WaveSurfer.js -->
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
</head>
<body>
    <div class="app-container">
        <header class="navbar">
            <div class="brand">
                <span class="icon">üè≠</span>
                <span class="text">AudioFormation</span>
            </div>
            <nav class="nav-links">
                <a href="#" onclick="app.showProjects()" class="active" id="nav-projects">Projects</a>
                <a href="#" class="disabled" id="nav-editor" onclick="app.showEditor()">Editor</a>
                <a href="#" class="disabled" id="nav-mix" onclick="app.showMix()">Mix</a>
                <a href="#" class="disabled" id="nav-export" onclick="app.showExport()">Export</a>
                <a href="#" class="disabled" id="nav-qc" onclick="app.showQC()">QC</a>
            </nav>
            <div class="status-bar">
                <span id="system-status" class="online">‚óè System Ready</span>
            </div>
        </header>

        <main class="content">
            <!-- Hidden file inputs -->
            <input type="file" id="file-upload-ref" accept=".wav,.mp3" style="display:none" onchange="app.handleRefUpload(this)">
            <input type="file" id="file-upload-music" accept=".wav,.mp3" style="display:none" onchange="app.handleMusicUpload(this)">

            <!-- Projects Grid View -->
            <div id="projects-view" class="view">
                <div class="view-header">
                    <h1>Projects</h1>
                    <button class="btn primary" onclick="app.refreshProjects()">‚Üª Refresh</button>
                </div>
                
                <div id="project-grid" class="project-grid">
                    <div class="card loading">Loading projects...</div>
                </div>
            </div>

            <!-- Project Editor View -->
            <div id="editor-view" class="view hidden">
                <div class="view-header">
                    <h1><span id="editor-project-id">Project</span> <span style="font-weight:400; opacity:0.5;">Editor</span></h1>
                    <div class="actions">
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <button class="btn primary" onclick="app.runAllPipeline()" id="btn-run-all">üöÄ Run All Pipeline</button>
                            <select id="run-from-select" style="padding:0.5rem; border-radius:4px; background:var(--card-bg); color:var(--text); border:1px solid var(--border);">
                                <option value="">Run From...</option>
                                <option value="validate">Validate</option>
                                <option value="generate">Generate</option>
                                <option value="qc-scan">QC Scan</option>
                                <option value="process">Process</option>
                                <option value="compose">Compose</option>
                                <option value="mix">Mix</option>
                                <option value="qc-final">QC Final</option>
                                <option value="export">Export</option>
                            </select>
                            <button class="btn" onclick="app.runFromStep()">‚ñ∂ Run</button>
                        </div>
                        <button class="btn" onclick="app.showProjects()">Close</button>
                        <button id="btn-save" class="btn primary" onclick="app.saveProject()">Save Changes</button>
                    </div>
                </div>
                
                <div class="editor-layout">
                    <aside class="sidebar">
                        <div class="nav-item active" onclick="app.switchTab('overview')" id="tab-btn-overview">Overview</div>
                        <div class="nav-item" onclick="app.switchTab('cast')" id="tab-btn-cast">Cast</div>
                        <div class="nav-item" onclick="app.switchTab('chapters')" id="tab-btn-chapters">Chapters</div>
                        <div class="nav-item" onclick="app.switchTab('engine')" id="tab-btn-engine">Engine Settings</div>
                        <div class="nav-item" onclick="app.switchTab('assets')" id="tab-btn-assets">Assets (SFX/Music)</div>
                        <div class="nav-item" onclick="app.switchTab('json')" id="tab-btn-json">Raw JSON</div>
                    </aside>
                    
                    <div class="main-panel">
                        
                        <!-- Overview Tab -->
                        <div id="tab-overview" class="tab-content">
                            <h2>Project Overview</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Languages</label>
                                    <div style="font-size:1.1rem; padding:0.5rem;" id="overview-languages">ar, en</div>
                                </div>
                                <div class="form-group">
                                    <label>Created</label>
                                    <div style="font-size:1.1rem; padding:0.5rem;" id="overview-created">2026-02-16</div>
                                </div>
                            </div>
                            
                            <h3>Pipeline Status</h3>
                            <div class="pipeline-stepper" id="pipeline-stepper">
                                <!-- Populated by JS -->
                            </div>
                            
                            <div style="margin-top:2rem;">
                                <h3>Hardware Detection</h3>
                                <div id="hardware-info" class="info-panel" style="font-family:monospace;">
                                    Loading hardware info...
                                </div>
                            </div>
                        </div>

                        <!-- Cast Tab -->
                        <div id="tab-cast" class="tab-content hidden">
                            <div class="flex-row" style="justify-content:space-between; align-items:center; margin-bottom:1rem;">
                                <h2>Cast & Voices</h2>
                                <button class="btn primary small" onclick="app.addCharacter()">+ Add Character</button>
                            </div>
                            <div id="cast-list">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Engine Tab -->
                        <div id="tab-engine" class="tab-content hidden">
                            <h2>Generation Settings</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Fallback Scope</label>
                                    <select id="conf-fallback-scope">
                                        <option value="chapter">Chapter (Retry)</option>
                                        <option value="project">Project (Switch All)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Fail Threshold %</label>
                                    <input type="number" id="conf-fail-thresh">
                                </div>
                            </div>
                            
                            <h3>Chunking & Stitching</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Chunk Max Chars</label>
                                    <input type="number" id="conf-chunk-chars">
                                </div>
                                <div class="form-group">
                                    <label>Strategy</label>
                                    <select id="conf-strategy">
                                        <option value="breath_group">Breath Group</option>
                                        <option value="sentence">Sentence</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Crossfade (ms)</label>
                                    <input type="number" id="conf-crossfade">
                                </div>
                                <div class="form-group">
                                    <label>Leading Silence (ms)</label>
                                    <input type="number" id="conf-silence">
                                </div>
                            </div>
                            
                            <!-- XTTS Advanced Settings -->
                            <div class="collapsible collapsed" onclick="app.toggleCollapse(this)">
                                <div class="collapsible-header">XTTS Configuration (Voice Cloning)</div>
                                <div class="collapsible-body" onclick="event.stopPropagation()">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Temperature (Creativity)</label>
                                            <input type="number" id="conf-xtts-temp" step="0.1" min="0.1" max="1.0">
                                        </div>
                                        <div class="form-group">
                                            <label>Repetition Penalty</label>
                                            <input type="number" id="conf-xtts-rep" step="0.5" min="1.0" max="10.0">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>VRAM Strategy</label>
                                            <select id="conf-xtts-vram">
                                                <option value="empty_cache_per_chapter">Empty Cache (Recommended)</option>
                                                <option value="conservative">Conservative (Unload Model)</option>
                                                <option value="reload_periodic">Periodic Reload</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h3>Mix Settings</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Target LUFS</label>
                                    <input type="number" id="conf-lufs" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Master Volume</label>
                                    <input type="number" id="conf-vol" step="0.1" max="1.0" min="0.0">
                                </div>
                            </div>
                        </div>

                        <!-- Chapters Tab -->
                        <div id="tab-chapters" class="tab-content hidden">
                            <div class="flex-row" style="justify-content:space-between; align-items:center; margin-bottom:1rem;">
                                <h2>Chapters</h2>
                                <button class="btn primary small" onclick="app.triggerIngest()">+ Ingest Text Files</button>
                                <input type="file" id="ingest-file-input" multiple accept=".txt" style="display:none" onchange="app.handleIngestFiles(this)">
                            </div>

                            <div class="list-header">
                                <span>ID</span>
                                <span>Title</span>
                                <span>Lang</span>
                                <span>Status</span>
                                <span>Actions</span>
                            </div>
                            <div id="chapter-list" class="list-group"></div>

                            <!-- Chapter Detail Editor (Hidden by default) -->
                            <div id="chapter-detail" class="detail-panel hidden" style="margin-top:2rem; border-top:1px solid var(--border); padding-top:1rem;">
                                <div class="flex-row" style="justify-content:space-between; align-items:center; margin-bottom:1rem;">
                                    <div style="display:flex; gap:1rem; align-items:center;">
                                        <h3 id="chap-detail-title" style="margin:0">Edit Chapter</h3>
                                    </div>
                                    <button class="btn" onclick="document.getElementById('chapter-detail').classList.add('hidden')">Close Editor</button>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Title</label>
                                        <input type="text" id="chap-title">
                                    </div>
                                    <div class="form-group">
                                        <label>Character</label>
                                        <select id="chap-character"></select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Mode</label>
                                        <select id="chap-mode">
                                            <option value="single">Single (Narrator)</option>
                                            <option value="multi">Multi-Speaker</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Energy</label>
                                        <select id="chap-energy">
                                            <option value="">(Default)</option>
                                            <option value="whisper">Whisper</option>
                                            <option value="quiet">Quiet</option>
                                            <option value="normal">Normal</option>
                                            <option value="loud">Loud</option>
                                            <option value="intense">Intense</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Pace</label>
                                        <select id="chap-pace">
                                            <option value="">(Default)</option>
                                            <option value="very slow">Very Slow</option>
                                            <option value="slow">Slow</option>
                                            <option value="moderate">Moderate</option>
                                            <option value="fast">Fast</option>
                                            <option value="very fast">Very Fast</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Emotion</label>
                                        <select id="chap-emotion">
                                            <option value="">(Default)</option>
                                            <option value="neutral">Neutral</option>
                                            <option value="wonder">Wonder</option>
                                            <option value="sadness">Sadness</option>
                                            <option value="tension">Tension</option>
                                            <option value="triumph">Triumph</option>
                                            <option value="contemplation">Contemplation</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assets Tab -->
                        <div id="tab-assets" class="tab-content hidden">
                            <div class="flex-row" style="gap:2rem;">
                                <div class="form-group" style="flex:1;">
                                    <h3>Generate SFX (FXForge)</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Type</label>
                                            <select id="sfx-type">
                                                <option value="whoosh">Whoosh</option>
                                                <option value="impact">Impact</option>
                                                <option value="ui_click">UI Click</option>
                                                <option value="static">Static</option>
                                                <option value="drone">Drone</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Duration (s)</label>
                                            <input type="number" id="sfx-duration" value="1.0" step="0.1">
                                        </div>
                                    </div>
                                    <button class="btn primary" onclick="app.generateSFX()">Generate SFX</button>
                                </div>
                                
                                <div class="form-group" style="flex:1; border-left:1px solid var(--border); padding-left:2rem;">
                                    <h3>Compose Music (Ambient)</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Preset</label>
                                            <select id="music-preset">
                                                <option value="contemplative">Contemplative</option>
                                                <option value="tense">Tense</option>
                                                <option value="wonder">Wonder</option>
                                                <option value="melancholy">Melancholy</option>
                                                <option value="triumph">Triumph</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Duration (s)</label>
                                            <input type="number" id="music-duration" value="60" step="1">
                                        </div>
                                    </div>
                                    <button class="btn primary" onclick="app.composeMusic()">Compose</button>
                                </div>
                            </div>
                            
                            <h3 style="margin-top:2rem;">Asset Library</h3>
                            <button class="btn small" onclick="app.fetchAssets()">‚Üª Refresh List</button>
                            <div id="assets-list" class="list-group" style="margin-top:1rem;">
                                <div class="card loading">Loading assets...</div>
                            </div>
                        </div>

                        <!-- JSON Tab -->
                        <div id="tab-json" class="tab-content hidden">
                            <textarea id="json-editor" spellcheck="false"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mix/Review View -->
            <div id="mix-view" class="view hidden">
                <div class="view-header">
                    <h1><span id="mix-project-id">Project</span> <span style="font-weight:400; opacity:0.5;">Timeline</span></h1>
                    <div class="actions">
                        <button class="btn" onclick="app.showProjects()">Close</button>
                    </div>
                </div>

                <div class="editor-layout">
                    <aside class="sidebar" style="width: 250px;">
                        <div style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--accent);">
                            Audio Files
                        </div>
                        <div id="mix-file-list" class="file-list">
                            <!-- Populated via JS -->
                        </div>
                    </aside>

                    <div class="main-panel" style="display:flex; flex-direction:column;">
                        <!-- Mix Toolbar -->
                        <div class="mix-toolbar" style="margin-bottom:1.5rem; display:flex; gap:1rem; align-items:center; padding-bottom:1rem; border-bottom:1px solid var(--border);">
                            <button id="btn-mix" class="btn primary" onclick="app.runMix()">‚òä Run Mix</button>
                            <span id="mix-status-badge" class="status-badge" style="display:none;">PENDING</span>
                            <div style="flex:1"></div>
                        </div>

                        <div id="waveform-container">
                            <div id="waveform"></div>
                            <div id="wave-timeline"></div>
                        </div>
                        
                        <div class="transport-controls">
                            <button id="play-btn" class="btn primary big">‚ñ∂ Play</button>
                            <span id="time-display">00:00 / 00:00</span>
                            <div style="flex:1"></div>
                            <label>Zoom</label>
                            <input type="range" id="zoom-slider" min="10" max="200" value="50">
                        </div>

                        <!-- Mix Configuration Panel -->
                        <div class="settings-panel" style="background:var(--bg-input); padding:1.5rem; border-radius:8px; border:1px solid var(--border); margin-bottom: 1.5rem;">
                            <h3 style="margin-top:0">Mix Configuration</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Music Source</label>
                                    <div style="display:flex; gap:0.5rem;">
                                        <select id="mix-music-file" style="flex:1;">
                                            <option value="">(Auto-detect latest)</option>
                                            <option value="none">(No Music)</option>
                                            <!-- Populated via JS -->
                                        </select>
                                        <button class="btn small" onclick="document.getElementById('file-upload-music').click()">Upload BGM</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Master Volume</label>
                                    <input type="number" id="mix-master-vol" step="0.1" min="0" max="1" value="0.9">
                                </div>
                                <div class="form-group">
                                    <label>Target LUFS</label>
                                    <input type="number" id="mix-target-lufs" step="0.1" value="-16.0">
                                </div>
                            </div>
                            
                            <h4 style="margin-top:1rem; border-bottom:1px solid #444; padding-bottom:0.5rem; font-size:0.9rem; color:var(--text-secondary);">Ducking (VAD)</h4>
                            <div class="form-row" style="margin-bottom:0.5rem;">
                                <div class="form-group">
                                    <label>Threshold</label>
                                    <input type="number" id="mix-duck-thresh" step="0.05" min="0" max="1" value="0.5">
                                </div>
                                <div class="form-group">
                                    <label>Attenuation (dB)</label>
                                    <input type="number" id="mix-duck-atten" step="1" max="0" value="-12">
                                </div>
                                <div class="form-group">
                                    <label>Look-ahead (ms)</label>
                                    <input type="number" id="mix-duck-lookahead" step="10" value="200">
                                </div>
                            </div>
                            <div class="form-row" style="margin-bottom:0;">
                                <div class="form-group">
                                    <label>Attack (ms)</label>
                                    <input type="number" id="mix-duck-attack" step="10" value="100">
                                </div>
                                <div class="form-group">
                                    <label>Release (ms)</label>
                                    <input type="number" id="mix-duck-release" step="10" value="500">
                                </div>
                            </div>
                        </div>

                        <div class="info-panel" id="track-info">
                            <h3>Select a track to review</h3>
                            <p>Files are loaded from <code>03_GENERATED/processed</code> or <code>06_MIX/renders</code>.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export View -->
            <div id="export-view" class="view hidden">
                <div class="view-header">
                    <h1>Export Audio</h1>
                    <div class="actions">
                        <button class="btn" onclick="app.showProjects()">Close</button>
                    </div>
                </div>
                
                <div class="editor-layout">
                    <div class="main-panel">
                        <div class="form-row" style="align-items: flex-end;">
                            <div class="form-group">
                                <label>Format</label>
                                <select id="export-format" onchange="app.onExportFormatChange()">
                                    <option value="mp3">MP3 (Chapters + Full)</option>
                                    <option value="m4b">M4B (Audiobook)</option>
                                    <option value="wav">WAV (Master)</option>
                                </select>
                            </div>
                            <div class="form-group" id="group-mp3-bitrate">
                                <label>Bitrate</label>
                                <select id="export-bitrate">
                                    <option value="128">128 kbps</option>
                                    <option value="192" selected>192 kbps</option>
                                    <option value="320">320 kbps</option>
                                </select>
                            </div>
                             <div class="form-group hidden" id="group-aac-bitrate">
                                <label>AAC Bitrate</label>
                                <select id="export-aac-bitrate">
                                    <option value="64">64 kbps</option>
                                    <option value="128" selected>128 kbps</option>
                                    <option value="192">192 kbps</option>
                                </select>
                            </div>
                            <button class="btn primary big" onclick="app.triggerExport()">üì¶ Export Now</button>
                        </div>

                        <!-- Metadata Section -->
                        <div id="export-metadata-section" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                            <h3>Metadata</h3>
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label>Title</label>
                                    <input type="text" id="meta-title">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Author</label>
                                    <input type="text" id="meta-author">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Narrator</label>
                                    <input type="text" id="meta-narrator">
                                </div>
                                <div class="form-group">
                                    <label>Year</label>
                                    <input type="number" id="meta-year">
                                </div>
                            </div>
                        </div>
                        
                        <div id="export-status-panel" class="info-panel hidden" style="margin-top:2rem;">
                            <h3>Export Status: <span id="export-status-text">Pending</span></h3>
                            <p id="export-status-msg"></p>
                        </div>
                        
                        <h3 style="margin-top:2rem;">Files</h3>
                        <div id="export-file-list">
                            <div class="card loading">No exported files yet. Run export above.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QC View -->
            <div id="qc-view" class="view hidden">
                <div class="view-header">
                    <h1>Quality Control</h1>
                    <div class="actions">
                        <button class="btn" onclick="app.showProjects()">Close</button>
                    </div>
                </div>
                
                <div class="editor-layout">
                    <div class="main-panel">
                        <div id="qc-reports-container">
                            <div class="card loading">Loading QC reports...</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script src="app.js"></script>
</body>
</html>
