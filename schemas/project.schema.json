{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://audioformation.dev/schemas/project.schema.json",
  "title": "AudioFormation Project",
  "description": "Single source of truth for an AudioFormation audio project.",
  "type": "object",
  "required": ["id", "version", "created", "languages", "chapters", "characters", "generation", "qc", "mix", "export"],

  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[A-Za-z0-9_-]+$",
      "description": "Unique project identifier (filesystem-safe)."
    },
    "version": {
      "type": "string",
      "description": "Schema version."
    },
    "created": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 creation timestamp."
    },
    "languages": {
      "type": "array",
      "items": { "type": "string", "minLength": 2, "maxLength": 5 },
      "minItems": 1,
      "description": "Supported languages (ISO 639-1 codes)."
    },

    "chapters": {
      "type": "array",
      "items": { "$ref": "#/$defs/chapter" },
      "description": "Ordered list of chapters."
    },

    "characters": {
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/character" },
      "minProperties": 1,
      "description": "Character ID â†’ voice/engine mapping."
    },

    "generation": { "$ref": "#/$defs/generationConfig" },
    "qc": { "$ref": "#/$defs/qcConfig" },
    "mix": { "$ref": "#/$defs/mixConfig" },
    "export": { "$ref": "#/$defs/exportConfig" }
  },

  "$defs": {
    "chapter": {
      "type": "object",
      "required": ["id", "title", "language", "source"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$"
        },
        "title": { "type": "string" },
        "language": { "type": "string", "minLength": 2 },
        "source": { "type": "string", "description": "Relative path to text file." },
        "character": { "type": "string", "description": "Character ID (single mode)." },
        "default_character": { "type": "string", "description": "Default character (multi mode)." },
        "mode": {
          "type": "string",
          "enum": ["single", "multi"],
          "default": "single"
        },
        "direction": { "$ref": "#/$defs/direction" }
      }
    },

    "character": {
      "type": "object",
      "required": ["name", "engine"],
      "properties": {
        "name": { "type": "string" },
        "engine": {
          "type": "string",
          "enum": ["edge", "xtts", "gtts", "elevenlabs", "openai-tts", "gemini-tts"]
        },
        "voice": { "type": ["string", "null"], "default": null },
        "dialect": {
          "type": "string",
          "enum": ["msa", "eg", "sa", "ae", "lb", "ma", "iq", "sy"],
          "default": "msa"
        },
        "persona": { "type": "string", "default": "" },
        "reference_audio": { "type": ["string", "null"], "default": null }
      }
    },

    "direction": {
      "type": "object",
      "properties": {
        "energy": { "type": "string" },
        "pace": { "type": "string" },
        "emotion": { "type": "string" }
      }
    },

    "generationConfig": {
      "type": "object",
      "required": ["chunk_max_chars", "chunk_strategy", "crossfade_ms"],
      "properties": {
        "chunk_max_chars": { "type": "integer", "minimum": 50, "maximum": 1000 },
        "chunk_strategy": {
          "type": "string",
          "enum": ["breath_group", "sentence", "fixed"]
        },
        "crossfade_ms": { "type": "integer", "minimum": 10, "maximum": 500 },
        "crossfade_min_ms": { "type": "integer", "minimum": 10, "maximum": 500 },
        "leading_silence_ms": { "type": "integer", "minimum": 0, "maximum": 2000 },
        "max_retries_per_chunk": { "type": "integer", "minimum": 0, "maximum": 10 },
        "fail_threshold_percent": { "type": "number", "minimum": 0, "maximum": 100 },
        "xtts_temperature": { "type": "number", "minimum": 0.0, "maximum": 2.0 },
        "xtts_repetition_penalty": { "type": "number", "minimum": 1.0, "maximum": 20.0 },
        "edge_tts_rate_limit_ms": { "type": "integer", "minimum": 0 },
        "edge_tts_concurrency": { "type": "integer", "minimum": 1, "maximum": 20 },
        "edge_tts_ssml": { "type": "boolean" },
        "xtts_vram_management": {
          "type": "string",
          "enum": ["empty_cache_per_chapter", "reload_periodic", "conservative"]
        }
      }
    },

    "qcConfig": {
      "type": "object",
      "properties": {
        "snr_method": {
          "type": "string",
          "enum": ["vad_noise_floor", "wada_snr"]
        },
        "snr_min_db": { "type": "number", "minimum": 0 },
        "max_duration_deviation_percent": { "type": "number", "minimum": 0, "maximum": 100 },
        "clipping_threshold_dbfs": { "type": "number", "maximum": 0 },
        "lufs_deviation_max": { "type": "number", "minimum": 0 },
        "pitch_jump_max_semitones": { "type": "number", "minimum": 0 },
        "boundary_artifact_check": { "type": "boolean" }
      }
    },

    "mixConfig": {
      "type": "object",
      "required": ["target_lufs"],
      "properties": {
        "master_volume": { "type": "number", "minimum": 0, "maximum": 1.0 },
        "target_lufs": { "type": "number", "maximum": 0 },
        "true_peak_limit_dbtp": { "type": "number", "maximum": 0 },
        "gap_between_chapters_sec": { "type": "number", "minimum": 0 },
        "ducking": { "$ref": "#/$defs/duckingConfig" }
      }
    },

    "duckingConfig": {
      "type": "object",
      "properties": {
        "method": { "type": "string", "enum": ["vad", "energy", "none"] },
        "vad_model": { "type": "string" },
        "vad_threshold": { "type": "number", "minimum": 0, "maximum": 1.0 },
        "vad_threshold_ar": { "type": "number", "minimum": 0, "maximum": 1.0 },
        "look_ahead_ms": { "type": "integer", "minimum": 0 },
        "attack_ms": { "type": "integer", "minimum": 0 },
        "release_ms": { "type": "integer", "minimum": 0 },
        "attenuation_db": { "type": "number", "maximum": 0 },
        "frequency_aware": { "type": "boolean" }
      }
    },

    "exportConfig": {
      "type": "object",
      "required": ["formats"],
      "properties": {
        "formats": {
          "type": "array",
          "items": { "type": "string", "enum": ["wav", "mp3", "flac", "m4b", "midi"] },
          "minItems": 1
        },
        "mp3_bitrate": { "type": "integer", "enum": [64, 96, 128, 160, 192, 256, 320] },
        "m4b_aac_bitrate": { "type": "integer", "enum": [64, 96, 128, 192, 256] },
        "include_cover_art": { "type": "boolean" },
        "cover_art": { "type": ["string", "null"] },
        "chapter_transition": { "type": "string", "enum": ["silence", "file"] },
        "chapter_transition_file": { "type": ["string", "null"] },
        "metadata": { "$ref": "#/$defs/exportMetadata" }
      }
    },

    "exportMetadata": {
      "type": "object",
      "properties": {
        "author": { "type": "string" },
        "narrator": { "type": "string" },
        "publisher": { "type": "string" },
        "year": { "type": "integer" },
        "description": { "type": "string" }
      }
    }
  }
}